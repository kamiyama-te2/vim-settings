-- ============================================================================
-- キーマッピング設定
-- ============================================================================

local map = vim.keymap.set
local opts = { noremap = true, silent = true }

-- ============================================================================
-- 基本キーマッピング
-- ============================================================================

-- 削除でレジスタに格納しない
map('n', 'x', '"_x', { desc = '削除でレジスタに格納しない' })

-- ノーマルモード中でもエンターキーで改行挿入
map('n', '<CR>', 'i<CR>', { desc = 'エンターキーで改行挿入' })

-- j, kによる移動を折り返されたテキストでも自然に振る舞うように変更
map('n', 'j', 'gj', { desc = '下に移動（折り返し対応）' })
map('n', 'k', 'gk', { desc = '上に移動（折り返し対応）' })

-- Ctrl + hjklでウィンドウ移動
map('n', '<C-h>', '<C-w>h', { desc = 'ウィンドウ左に移動' })
map('n', '<C-j>', '<C-w>j', { desc = 'ウィンドウ下に移動' })
map('n', '<C-k>', '<C-w>k', { desc = 'ウィンドウ上に移動' })
map('n', '<C-l>', '<C-w>l', { desc = 'ウィンドウ右に移動' })

-- Shift + 矢印でウィンドウサイズ変更
map('n', '<S-Left>', '<C-w><', { desc = 'ウィンドウ幅を狭くする' })
map('n', '<S-Right>', '<C-w>>', { desc = 'ウィンドウ幅を広くする' })
map('n', '<S-Up>', '<C-w>-', { desc = 'ウィンドウ高さを低くする' })
map('n', '<S-Down>', '<C-w>+', { desc = 'ウィンドウ高さを高くする' })

-- {}で空行を検索
map('n', '{', '?^\\s*$<CR>', { desc = '上の空行に移動' })
map('n', '}', '/^\\s*$<CR>', { desc = '下の空行に移動' })

-- ============================================================================
-- インサートモードのキーマッピング
-- ============================================================================

-- Ctrl + sで保存、Ctrl + qで終了
map('i', '<C-s>', '<Esc>:w<CR>', { desc = 'ファイル保存' })
map('i', '<C-q>', '<Esc>:q<CR>', { desc = 'ファイル終了' })

-- ============================================================================
-- リーダーキーのマッピング (スペース)
-- ============================================================================

vim.g.mapleader = " "
vim.o.timeoutlen = 400

-- Escapeキー（挿入モードから抜ける）
map('i', '<Leader>j', '<Esc>', { desc = 'インサートモードから抜ける' })

-- ファイル操作
map('n', '<Leader>w', ':w<CR>', { desc = 'ファイル保存' })
map('n', '<Leader>q', ':q<CR>', { desc = 'ファイル終了' })

-- 全選択
map('n', '<Leader>a', 'myggVG$', { desc = '全選択（ノーマルモード）' })
map('i', '<Leader>a', '<Esc>myggVG$', { desc = '全選択（インサートモードから）' })

-- ウィンドウ移動（スペース2回）
map('n', '<Leader><Leader>', '<C-w>w', { desc = '次のウィンドウに移動' })

-- ============================================================================
-- インデント操作
-- ============================================================================

-- Tabでインデントを増やす
map('n', '<Tab>', '>>', { desc = 'インデントを増やす' })
map('v', '<Tab>', '>gv', { desc = 'インデントを増やす（選択維持）' })

-- Shift+Tabでインデントを減らす
map('n', '<S-Tab>', '<<', { desc = 'インデントを減らす' })
map('v', '<S-Tab>', '<gv', { desc = 'インデントを減らす（選択維持）' })

-- ============================================================================
-- 日本語入力用キーマッピング
-- ============================================================================

-- 日本語入力がオンのままでも使えるコマンド
map('n', 'あ', 'a', { desc = '追加モード（日本語入力対応）' })
map('n', 'い', 'i', { desc = '挿入モード（日本語入力対応）' })
map('n', 'う', 'u', { desc = 'アンドゥ（日本語入力対応）' })
map('n', 'お', 'o', { desc = '新しい行を開く（日本語入力対応）' })
map('n', 'っd', 'dd', { desc = '行削除（日本語入力対応）' })
map('n', 'っy', 'yy', { desc = '行コピー（日本語入力対応）' })

-- 全角スペース + 全角文字でのマッピング
map('i', '　ｊ', '<Esc>', { desc = 'インサートモードから抜ける（全角）' })
map('n', '　ｗ', ':w<CR>', { desc = 'ファイル保存（全角）' })
map('n', '　　', '<C-w>w', { desc = 'ウィンドウ移動（全角）' })
map('n', '　ｒ', ':source ~/.vimrc<CR>', { desc = 'vimrc読み込み（全角）' })
map('n', '　ｖｒ', ':new ~/.vimrc<CR>', { desc = 'vimrc編集（全角）' })
map('i', '　ａ', '<Esc>myggVG$', { desc = '全選択（インサートモードから、全角）' })
map('n', '　ａ', 'myggVG$', { desc = '全選択（ノーマルモード、全角）' })
map('n', '　ｑ', ':q<CR>', { desc = 'ファイル終了（全角）' })

-- ============================================================================
-- 日本語検索用キーマッピング
-- ============================================================================

-- スペース + f(F,t,T) で digraph を入力で、日本語の検索ができるようにする
map('n', '<space>f', 'f<C-k>', { desc = '日本語文字検索（前方）' })
map('n', '<space>F', 'F<C-k>', { desc = '日本語文字検索（後方）' })
map('n', '<space>t', 't<C-k>', { desc = '日本語文字まで移動（前方）' })
map('n', '<space>T', 'T<C-k>', { desc = '日本語文字まで移動（後方）' })

-- ============================================================================
-- その他のキーマッピング
-- ============================================================================

-- 検索ハイライトをクリア
map('n', '<Esc><Esc>', ':nohlsearch<CR>', { desc = '検索ハイライトをクリア' })